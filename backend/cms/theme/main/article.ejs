<%- await include('../layout/header.ejs') %>
<%

function _find(categoryId,list){
  for(const item of list){
    if(item.id===categoryId) return true;
    if(item.children && item.children.length>0){
      const res=_find(categoryId,item.children);
      if(res) return true;
    }
  }
  return false;
}

  // cache
  if(!site._docTree){
    site._docTree={
      relativeTop:{},
      tree:{},
    };
  }
  // relativeTop
  let relativeTop=site._docTree.relativeTop[article.categoryId];
  if(relativeTop===undefined){
    relativeTop=await ctx.performAction({
      method: 'post',
      url: '/a/cms/category/relativeTop',
      body: { categoryId: article.categoryId },
    });
    // tree
    let relativeTopTree=null;
    if(relativeTop){
      relativeTopTree=await ctx.performAction({
        method: 'post',
        url: '/a/cms/category/tree',
        body: {
          atomClass: site.atomClass,
          categoryId: relativeTop.id,
        },
      });
    }
    // save
    site._docTree.relativeTop[article.categoryId]=relativeTop;
    if(relativeTop) {
      site._docTree.tree[relativeTop.id]=relativeTopTree;
    }
  }
  // env
  if(relativeTop){
    env('_docTree.relativeTop',relativeTop);
    env('_docTree.tree',site._docTree.tree[relativeTop.id]);
    if(!site._docTree.tree[relativeTop.id]){
      console.log('+ null article: ',relativeTop.id, article.url);
    }else{
      if(!_find(article.categoryId,site._docTree.tree[relativeTop.id].list)){
        console.log('----- article: ',article.url);
      }else{
        //console.log('+ article:',article.url);
      }
    }
  }
%>
<div class="doc-container">
<div class="category-sidebar">
  <h3 class="title"></h3>
  <div class="tree"></div>
</div>
<article class="article-doc">
  <%- await include('../layout/article/title.ejs')%>
  <div class="article-body">
    <%- article.html %>
  </div>
  <%- await include('../layout/article/attachments.ejs') %>
  <%- await include('../layout/article/socialshare.ejs') %>
  <%- await include('../layout/article/stat.ejs') %>
  <%- await include('../layout/article/brothers.ejs') %>
  <%- await include('../layout/article/comments.ejs') %>
</article>
</div>
<%- await include('../layout/footer.ejs') %>
